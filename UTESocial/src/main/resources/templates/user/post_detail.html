<!DOCTYPE html>
<html lang="vi" data-bs-theme="dark" xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ch·ªânh s·ª≠a b√†i vi·∫øt - AloUTE</title>
<!-- Bootstrap CSS -->
<link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css"
	rel="stylesheet">
<!-- Bootstrap Icons -->
<link rel="stylesheet"
	href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
<link rel="stylesheet" th:href="@{/css/style.css}" />
</head>
<body class="text-light">

	<nav class="navbar sticky-top">
		<div class="container-xl">
			<a class="navbar-brand fw-bold fs-4 d-flex align-items-center"
				th:href="@{/home}"> <svg class="bi me-2" width="32" height="32"
					fill="#0ea5e9">
					<path stroke-linecap="round" stroke-linejoin="round"
						stroke-width="2" d="M12 6.253v11.494m-9-5.747h18"
						stroke="currentColor"></path></svg> AloUTE
			</a>

			<ul
				class="navbar-nav flex-row gap-4 position-absolute start-50 translate-middle-x">
			</ul>
		</div>
	</nav>

	<div class="container-xl mt-4">
		<div class="row g-4">
			<div class="col-lg-3 d-none d-lg-block">
				<aside class="sticky-top" style="top: 80px;">
					<ul class="nav flex-column gap-1">
						<li class="nav-item"><a
							class="nav-link rounded-pill fs-5 fw-bold d-flex align-items-center gap-3 p-2"
							href="/home"> <i class="bi bi-house-door-fill fs-3"></i> <span>Trang
									ch·ªß</span>
						</a></li>
						<li class="nav-item"><a
							class="nav-link rounded-pill fs-5 fw-bold d-flex align-items-center gap-3 p-2"
							href="/upload"> <i class="bi bi-upload fs-3"></i> <span>ƒêƒÉng
									t·∫£i</span>
						</a></li>
						<li class="nav-item"><a
							class="nav-link rounded-pill fs-5 fw-bold d-flex align-items-center gap-3 p-2"
							href="/search"> <i class="bi bi-search fs-3"></i> <span>T√¨m
									ki·∫øm</span>
						</a></li>
						<li class="nav-item"><a
							class="nav-link rounded-pill fs-5 fw-bold d-flex align-items-center gap-3 p-2"
							href="/friend"> <i class="bi bi-people fs-3"></i> <span>B·∫°n
									b√®</span>
						</a></li>
						<li class="nav-item"><a id="nav-group"
							class="nav-link rounded-pill fs-5 fw-bold d-flex align-items-center gap-3 p-2"
							href="/group"> <i class="bi bi-globe2 fs-3"></i> <span>Nh√≥m</span>
						</a></li>
						<li class="nav-item"><a
							class="nav-link rounded-pill fs-5 fw-bold d-flex align-items-center gap-3 p-2"
							href="#"> <i class="bi bi-envelope fs-3"></i> <span>Tin
									nh·∫Øn</span>
						</a></li>
						<li class="nav-item"><a
							class="nav-link rounded-pill fs-5 fw-bold d-flex align-items-center gap-3 p-2"
							href="#"> <i class="bi bi-bell fs-3"></i> <span>Th√¥ng
									b√°o</span>
						</a></li>
						<li class="nav-item" th:if="${user != null}"><a
							class="nav-link rounded-pill fs-5 fw-bold d-flex align-items-center gap-3 p-2"
							th:href="@{/{username}(username=${user.nameUser})}"> <i
								class="bi bi-person-circle fs-3"></i> <span>C√° nh√¢n</span>
						</a></li>
						<li class="nav-item"><a
							class="nav-link rounded-pill fs-5 fw-bold d-flex align-items-center gap-3 p-2"
							href="/setting"> <i class="bi bi-gear fs-3"></i> <span>C√†i
									ƒë·∫∑t</span>
						</a></li>
						<li class="nav-item mt-2"><a
							class="nav-link text-danger rounded-pill fs-5 fw-bold d-flex align-items-center gap-3 p-2"
							href="/logout"> <i class="bi bi-box-arrow-right fs-3"></i> <span>ƒêƒÉng
									xu·∫•t</span>
						</a></li>
					</ul>

				</aside>

			</div>
			<div class="col-lg-9">
				<main class="d-grid gap-3">
					<div class="card rounded-4 overflow-hidden">
						<div class="modal fade"
							th:id="'reportPostModal__' + ${post.postId}" tabindex="-1"
							aria-labelledby="reportPostLabel" aria-hidden="true">
							<div class="modal-dialog modal-dialog-centered">
								<div class="modal-content">
									<div class="modal-header">
										<h5 class="modal-title" id="reportPostLabel">B√°o c√°o b√†i
											vi·∫øt</h5>
										<button type="button" class="btn-close"
											data-bs-dismiss="modal" aria-label="ƒê√≥ng"></button>
									</div>
									<div class="modal-body">
										<form method="post" th:action="@{/report-post}">
											<input type="hidden" name="postId" th:value="${post.postId}" />
											<div class="mb-3">
												<label for="reason" class="form-label">L√Ω do b√°o c√°o</label>
												<textarea name="reason" class="form-control" rows="4"
													placeholder="Nh·∫≠p l√Ω do..."></textarea>
											</div>
											<div class="d-flex justify-content-end">
												<button type="button" class="btn btn-secondary me-2"
													data-bs-dismiss="modal">H·ªßy</button>
												<button type="submit" class="btn btn-danger">G·ª≠i
													b√°o c√°o</button>
											</div>
										</form>
									</div>
								</div>
							</div>
						</div>
						<div class="card-body">
							<div
								class="d-flex align-items-center gap-3 mb-3 position-relative">
								<img class="rounded-circle" th:src="${post.user.avatarUrl}"
									alt="Avatar" width="48" height="48" />
								<div>
									<p class="fw-bold mb-0" th:text="${post.user.fullName}">
										T√™n ng∆∞·ªùi d√πng</p>
									<a class="fw mb-0 user-link" th:text="${post.user.nameUser}"
										th:href="@{/{username}(username=${post.user.nameUser})}"></a>
									<p class="text-muted small mb-0">
										<span
											th:text="${#temporals.format(post.createdAt, 'dd/MM/yyyy HH:mm')}"></span>
									</p>
								</div>
								<!-- G√≥c ph·∫£i: Visibility -->
								<div
									class="position-absolute top-0 end-0 me-2 mt-1 d-flex align-items-center gap-2">

									<!-- N√∫t tr√≤n ch·ªânh s·ª≠a b√†i vi·∫øt -->
									<button th:if="${post.user.userId == user.userId}"
										type="button" class="btn btn-icon btn-gray-custom"
										th:attr="data-post-id=${post.postId}"
										onclick="openEditPost(this)" title="Ch·ªânh s·ª≠a b√†i vi·∫øt">
										<i class="bi bi-pencil-square"></i>
									</button>

									<!-- N·∫øu l√† b√†i vi·∫øt c·ªßa ng∆∞·ªùi kh√°c -->
									<span class="badge rounded-pill bg-secondary text-light">
										<span th:switch="${post.visibility}"> <span
											th:case="'public'">C√¥ng khai</span> <span th:case="'friends'">B·∫°n
												b√®</span> <span th:case="'private'">Ch·ªâ m√¨nh t√¥i</span>
									</span>
									</span>
								</div>
							</div>
							<p th:text="${post.content}"></p>
							<!-- Th∆∞ vi·ªán ·∫£nh/video d·∫°ng thanh tr∆∞·ª£t -->
							<div
								th:if="${post.attachments != null and !post.attachments.isEmpty()}"
								class="attachment-scroll mt-3">
								<div th:each="att : ${post.attachments}"
									class="attachment-item text-center">
									<!-- N·∫øu l√† ·∫£nh -->
									<img th:if="${att.fileType.startsWith('image')}"
										th:src="${att.fileUrl}" alt="·∫¢nh ƒë√≠nh k√®m" />

									<!-- N·∫øu l√† video -->
									<video th:if="${att.fileType.startsWith('video')}"
										th:src="${att.fileUrl}" controls class="rounded-3"></video>

									<!-- N·∫øu l√† file kh√°c -->
									<a
										th:if="${!att.fileType.startsWith('image') and !att.fileType.startsWith('video')}"
										th:href="${att.fileUrl}" class="attachment-file"
										target="_blank"> <i class="bi bi-paperclip"></i> <span
										th:text="${#strings.substring(att.fileUrl, att.fileUrl.lastIndexOf('/') + 1)}"></span>
									</a>
								</div>
							</div>
						</div>

						<div class="card-body d-flex gap-2 post-actions">
							<div
								class="d-flex justify-content-between align-items-center w-100">
								<button
									class="btn text-muted d-flex align-items-center gap-2 like-btn"
									type="button" th:attr="data-post-id=${post.postId}"
									th:attrappend="data-liked=${likedPostIds.contains(post.postId)}">
									<i
										th:classappend="${likedPostIds.contains(post.postId)} ? ' bi-heart-fill text-danger' : ' bi-heart'"
										class="bi"></i> <span th:text="${post.likesCount}">0</span> <span
										class="ms-1">Th√≠ch</span>
								</button>
								<button class="btn text-muted d-flex align-items-center gap-2">
									<i class="bi bi-chat"></i> <span
										th:text="${post.commentsCount}">0</span> <span class="ms-1">B√¨nh
										lu·∫≠n</span>
								</button>
								<button th:if="${post.user.userId != user.userId}"
									class="btn text-muted d-flex align-items-center gap-2 repost-btn"
									th:attr="data-post-id=${post.postId}"
									th:attrappend="data-reposted=${repostedPostIds.contains(post.postId)}">
									<i
										th:classappend="${repostedPostIds.contains(post.postId)} ? ' text-primary' : ''"
										class="bi bi-repeat"></i> <span th:text="${post.shareCount}">0</span>
									<span class="ms-1">ƒêƒÉng l·∫°i</span>
								</button>
								<button th:if="${post.user.userId != user.userId}"
									class="btn text-muted d-flex align-items-center gap-2"
									data-bs-toggle="modal"
									th:attr="data-bs-target='#reportPostModal__' + ${post.postId}">
									<i class="bi bi-flag"></i> <span class="ms-1">B√°o c√°o</span>
								</button>
							</div>
						</div>
					</div>
					<!-- üì¢ H·ªòP B√åNH LU·∫¨N -->
					<div class="card-body border-top pt-3">
						<div class="d-flex flex-column gap-3">

							<div class="comments-list d-flex flex-column gap-3 mb-3">
								<div th:each="c : ${comments}" 
								     class="comment-item d-flex gap-3"
								     th:attr="data-comment-id=${c.commentId}"
								     th:data-avatar="${c.user.avatarUrl}"
								     th:data-username="${c.user.nameUser}"
								     th:data-time="${#temporals.format(c.createdAt, 'dd/MM/yyyy HH:mm')}"
								     th:data-content="${c.content}"
								     th:data-likes="${c.likeCount}">

									<img th:src="${c.user.avatarUrl}" alt="Avatar"
										class="rounded-circle flex-shrink-0" width="40" height="40">
									<div class="comment-content flex-grow-1">
										<div class="d-flex justify-content-between align-items-start">
											<div>
												<span class="fw-bold mb-0" th:text="${c.user.fullName}">T√™n</span>
												<a class="fw mb-0 user-link" th:text="${c.user.nameUser}"
															th:href="@{/{username}(username=${c.user.nameUser})}"></a>
												<small class="text-muted ms-2"
													th:text="${#temporals.format(c.createdAt, 'dd/MM/yyyy HH:mm')}"></small>
											</div>

										</div>
										<p class="mb-1" th:text="${c.content}">N·ªôi dung</p>
										<div class="d-flex gap-3">
											<button
												class="btn btn-sm text-muted d-flex align-items-center gap-1">
												<i class="bi bi-heart"></i> <span th:text="${c.likeCount}">0</span>
											</button>
											<button
												class="btn btn-sm text-muted p-0 open-reply-modal-btn"
												type="button" data-bs-toggle="modal"
												data-bs-target="#commentThreadModal">B√¨nh lu·∫≠n</button>
										</div>
									</div>
								</div>
							</div>

							<!-- ‚úçÔ∏è Form nh·∫≠p b√¨nh lu·∫≠n m·ªõi -->
							<form th:action="@{/comments/add}" method="post" class="mt-3">
							    <!-- üëá G·ª≠i k√®m ID b√†i vi·∫øt -->
							    <input type="hidden" name="postId" th:value="${post.postId}" />
							
							    <div class="d-flex align-items-center gap-2 mt-4">
							        <img th:src="${user.avatar}" class="rounded-circle" width="48" height="48">
							        <!-- üëá Th√™m name ƒë·ªÉ controller nh·∫≠n ƒë∆∞·ª£c n·ªôi dung -->
							        <input type="text" name="content" class="form-control rounded-pill"
							               placeholder="Vi·∫øt b√¨nh lu·∫≠n c·ªßa b·∫°n..." required>
							        <button type="submit" class="btn btn-primary rounded-circle">
							            <i class="bi bi-send"></i>
							        </button>
							    </div>
							</form>

						</div>
					</div>
				</main>
			</div>
		</div>
	</div>
	<!-- Modal nh·∫≠p ph·∫£n h·ªìi -->
	<!-- üìå Modal Thread -->
	<div class="modal fade" id="commentThreadModal" tabindex="-1"
		aria-labelledby="commentThreadLabel" aria-hidden="true">
		<div class="modal-dialog modal-dialog-centered modal-lg">
			<div class="modal-content bg-dark text-light">

				<!-- üßæ B√¨nh lu·∫≠n ƒëang ƒë∆∞·ª£c ph·∫£n h·ªìi -->
				<div class="modal-header border-0">
					<div class="d-flex gap-3 align-items-start w-100">
						<img id="thread-avatar" src="" alt="Avatar" class="rounded-circle"
							width="48" height="48">
						<div class="flex-grow-1">
							<div class="d-flex align-items-center gap-2 mb-1">
								<h6 id="thread-username" class="fw-bold mb-0"></h6>
								<small id="thread-time" class="text-muted"></small>
							</div>
							<p id="thread-content" class="mb-2"></p>
							<div class="d-flex align-items-center gap-3">
								<button
									class="btn btn-sm p-0 d-flex align-items-center gap-1 comment-like-btn"
									type="button">
									<i class="bi bi-heart"></i> <span id="thread-like">0</span>
								</button>
								<button class="btn btn-sm text-muted p-0" id="thread-reply-btn">
									B√¨nh lu·∫≠n</button>
							</div>
						</div>
					</div>
				</div>

				<hr class="m-0 border-secondary">

				<!-- üí¨ Danh s√°ch ph·∫£n h·ªìi -->
				<div class="modal-body">
					<div id="reply-list" class="d-flex flex-column gap-3">
						<!-- replies render t·∫°i ƒë√¢y -->
					</div>
				</div>

				<hr class="m-0 border-secondary">

				<!-- üìù Form nh·∫≠p ph·∫£n h·ªìi -->
				<div class="modal-footer border-0">
					<div class="d-flex align-items-start gap-2 w-100">
						<img th:src="${user.avatar}" alt="Avatar"
							class="rounded-circle" width="48" height="48">
						<textarea id="reply-input" class="form-control"
							placeholder="Ph·∫£n h·ªìi b√¨nh lu·∫≠n n√†y..." rows="2"></textarea>
					</div>
					<button class="btn btn-primary mt-2" id="send-reply-btn">G·ª≠i</button>
				</div>

			</div>
		</div>
	</div>

	<script
		src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
<script>
// =============================
// üìÅ T·∫¢I ·∫¢NH/VIDEO M·ªöI (gi·ªØ nguy√™n logic c·ªßa b·∫°n)
// =============================
document.addEventListener('DOMContentLoaded', () => {
  const newFilesInput = document.getElementById('new-files-input');
  const newFilesPreviewContainer = document.getElementById('new-files-preview');
  if (!newFilesInput) return;

  let newFileStore = new DataTransfer();

  newFilesInput.addEventListener('change', (e) => handleFiles(e.target.files));

  function handleFiles(files) {
    for (const file of files) newFileStore.items.add(file);
    renderNewPreviews();
  }

  function renderNewPreviews() {
    newFilesPreviewContainer.innerHTML = '';
    Array.from(newFileStore.files).forEach((file, index) => {
      const reader = new FileReader();
      const previewItem = document.createElement('div');
      previewItem.className = 'preview-item';

      reader.onload = (e) => {
        let mediaElement;
        if (file.type.startsWith('image/')) {
          mediaElement = document.createElement('img');
          mediaElement.src = e.target.result;
        } else if (file.type.startsWith('video/')) {
          mediaElement = document.createElement('video');
          mediaElement.src = e.target.result;
          mediaElement.controls = true;
        } else {
          mediaElement = document.createElement('div');
          mediaElement.className =
            'file-placeholder d-flex flex-column align-items-center justify-content-center rounded p-2 text-center';
          mediaElement.innerHTML = `<i class="bi bi-file-earmark-text fs-1"></i><small class="text-truncate">${file.name}</small>`;
        }
        previewItem.appendChild(mediaElement);
      };
      reader.readAsDataURL(file);

      const removeBtn = document.createElement('button');
      removeBtn.type = 'button';
      removeBtn.className = 'btn btn-sm btn-danger rounded-circle remove-btn';
      removeBtn.innerHTML = '&times;';
      removeBtn.onclick = () => removeNewFile(index);

      previewItem.appendChild(removeBtn);
      newFilesPreviewContainer.appendChild(previewItem);
      newFilesInput.files = newFileStore.files;
    });
  }

  function removeNewFile(index) {
    const newFiles = new DataTransfer();
    const oldFiles = Array.from(newFileStore.files);
    oldFiles.forEach((file, i) => {
      if (i !== index) newFiles.items.add(file);
    });
    newFileStore = newFiles;
    renderNewPreviews();
  }
});

function removeExistingFile(button) {
  const previewItem = button.closest('.preview-item');
  const fileId = previewItem.dataset.fileId;
  const filesToDeleteContainer = document.getElementById('files-to-delete');
  const hiddenInput = document.createElement('input');
  hiddenInput.type = 'hidden';
  hiddenInput.name = 'deleteFileIds';
  hiddenInput.value = fileId;
  filesToDeleteContainer.appendChild(hiddenInput);
  previewItem.style.display = 'none';
}
</script>

<!-- ============================
  ‚ù§Ô∏è LIKE POST
============================ -->
<script>
document.addEventListener("DOMContentLoaded", function () {
  document.querySelectorAll(".like-btn").forEach((btn) => {
    btn.addEventListener("click", () => {
      const postId = btn.getAttribute("data-post-id");
      fetch("/post/toggle-like/json", {
        method: "POST",
        headers: { "Content-Type": "application/json", "X-Requested-With": "XMLHttpRequest" },
        body: JSON.stringify({ postId }),
      })
        .then((res) => res.json())
        .then((data) => {
          if (!data.success) return alert("L·ªói khi c·∫≠p nh·∫≠t l∆∞·ª£t th√≠ch.");
          btn.querySelector("span").textContent = data.likesCount;
          const icon = btn.querySelector("i");
          if (data.liked) {
            icon.classList.add("bi-heart-fill", "text-danger");
            icon.classList.remove("bi-heart");
            btn.setAttribute("data-liked", "true");
          } else {
            icon.classList.remove("bi-heart-fill", "text-danger");
            icon.classList.add("bi-heart");
            btn.setAttribute("data-liked", "false");
          }
        })
        .catch(() => alert("Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn m√°y ch·ªß."));
    });
  });
});
</script>

<!-- ============================
  üîÅ REPOST
============================ -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  document.querySelectorAll(".repost-btn").forEach((btn) => {
    btn.addEventListener("click", () => {
      const postId = btn.getAttribute("data-post-id");
      fetch("/post/toggle-repost/json", {
        method: "POST",
        headers: { "Content-Type": "application/json", "X-Requested-With": "XMLHttpRequest" },
        body: JSON.stringify({ postId }),
      })
        .then((res) => res.json())
        .then((data) => {
          if (!data.success) return alert(data.message || "‚ùå L·ªói ƒëƒÉng l·∫°i.");
          btn.querySelector("span").textContent = data.repostCount;
          const icon = btn.querySelector("i");
          data.reposted ? icon.classList.add("text-primary") : icon.classList.remove("text-primary");
          const toast = document.createElement("div");
          toast.className = "alert alert-success position-fixed top-0 end-0 m-3 shadow";
          toast.style.zIndex = "1055";
          toast.textContent = data.reposted ? "‚úÖ ƒêƒÉng l·∫°i th√†nh c√¥ng!" : "‚õî H·ªßy ƒëƒÉng l·∫°i!";
          document.body.appendChild(toast);
          setTimeout(() => toast.remove(), 2000);
        })
        .catch(() => alert("‚ö†Ô∏è Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn m√°y ch·ªß."));
    });
  });
});
</script>

<!-- ============================
  ‚úèÔ∏è EDIT POST
============================ -->
<script>
function openEditPost(button) {
  const postId = button.getAttribute('data-post-id');
  if (!postId) return console.error('‚ùå Kh√¥ng t√¨m th·∫•y ID b√†i vi·∫øt!');
  window.location.href = `/posts/${postId}/edit`;
}
</script>

<!-- ============================
  üí¨ THREAD B√åNH LU·∫¨N
============================ -->
<script>
document.addEventListener('DOMContentLoaded', () => {
  const modal = document.getElementById('commentThreadModal');
  const threadAvatar = document.getElementById('thread-avatar');
  const threadUsername = document.getElementById('thread-username');
  const threadTime = document.getElementById('thread-time');
  const threadContent = document.getElementById('thread-content');
  const threadLike = document.getElementById('thread-like');
  const replyList = document.getElementById('reply-list');
  const replyInput = document.getElementById('reply-input');

  let currentCommentId = null;
  const threadHistory = []; // ü™ú stack l·ªãch s·ª≠ ƒë·ªÉ quay l·∫°i

  function renderThread(comment) {
    currentCommentId = comment.id;
    threadAvatar.src = comment.avatar;
    threadUsername.textContent = comment.username;
    threadTime.textContent = comment.time;
    threadContent.textContent = comment.content;
    threadLike.textContent = comment.likes;
  }

  function openThread(comment, pushHistory = false) {
    if (pushHistory && currentCommentId) {
      // L∆∞u comment hi·ªán t·∫°i v√†o stack
      threadHistory.push({
        id: currentCommentId,
        avatar: threadAvatar.src,
        username: threadUsername.textContent,
        time: threadTime.textContent,
        content: threadContent.textContent,
        likes: threadLike.textContent
      });
    }

    renderThread(comment);
    replyList.innerHTML = '';

    fetch(`/comments/${comment.id}/replies`)
      .then(res => res.json())
      .then(replies => {
        if (!replies || replies.length === 0) {
          replyList.innerHTML = `<p class="text-muted ms-2">Ch∆∞a c√≥ ph·∫£n h·ªìi n√†o</p>`;
        } else {
          replies.forEach(r => {
            const el = document.createElement('div');
            el.className = 'd-flex gap-3 align-items-start p-2 rounded-3 bg-dark-subtle reply-item';
            el.dataset.commentId = r.id;
            el.dataset.avatar = r.avatar;
            el.dataset.username = r.username;
            el.dataset.time = r.time;
            el.dataset.content = r.content;
            el.dataset.likes = r.likes;
            el.innerHTML = `
              <img src="${r.avatar}" alt="Avatar" class="rounded-circle" width="40" height="40">
              <div class="flex-grow-1">
                <div class="d-flex align-items-center gap-2 mb-1">
                  <h6 class="fw-bold mb-0">${r.username}</h6>
                  <small class="text-muted">${r.time}</small>
                </div>
                <p class="mb-2">${r.content}</p>
                <div class="d-flex align-items-center gap-3">
                  <button class="btn btn-sm p-0 d-flex align-items-center gap-1 comment-like-btn" type="button">
                    <i class="bi bi-heart"></i> <span>${r.likes}</span>
                  </button>
                  <button class="btn btn-sm text-muted p-0 reply-to-reply-btn" type="button">B√¨nh lu·∫≠n</button>
                </div>
              </div>`;
            replyList.appendChild(el);
          });
        }
      });
  }

  // üß≤ Click b√¨nh lu·∫≠n cha
  document.querySelectorAll('.open-reply-modal-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const parent = btn.closest('.comment-item');
      const commentData = {
        id: parent.dataset.commentId,
        avatar: parent.dataset.avatar,
        username: parent.dataset.username,
        time: parent.dataset.time,
        content: parent.dataset.content,
        likes: parent.dataset.likes
      };
      openThread(commentData);
      new bootstrap.Modal(modal).show();
    });
  });

  // üí¨ Click reply ‚Üí m·ªü l·∫°i modal theo reply
  replyList.addEventListener('click', e => {
    const replyBtn = e.target.closest('.reply-to-reply-btn');
    if (replyBtn) {
      const item = replyBtn.closest('.reply-item');
      const replyData = {
        id: item.dataset.commentId,
        avatar: item.dataset.avatar,
        username: item.dataset.username,
        time: item.dataset.time,
        content: item.dataset.content,
        likes: item.dataset.likes
      };
      openThread(replyData, true);
    }
  });

  // üìù G·ª≠i ph·∫£n h·ªìi
  document.getElementById('send-reply-btn').addEventListener('click', () => {
    const text = replyInput.value.trim();
    if (!text) return alert('Vui l√≤ng nh·∫≠p n·ªôi dung ph·∫£n h·ªìi!');
    fetch('/comments/reply', {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: new URLSearchParams({ parentId: currentCommentId, content: text })
    }).then(() => {
      replyInput.value = '';
      openThread({
        id: currentCommentId,
        avatar: threadAvatar.src,
        username: threadUsername.textContent,
        time: threadTime.textContent,
        content: threadContent.textContent,
        likes: threadLike.textContent
      });
    });
  });

  // ‚ù§Ô∏è Like tr√™n replies
  replyList.addEventListener('click', e => {
    const likeBtn = e.target.closest('.comment-like-btn');
    if (likeBtn) {
      const liked = likeBtn.classList.toggle('liked');
      const span = likeBtn.querySelector('span');
      let count = parseInt(span.textContent);
      span.textContent = liked ? count + 1 : count - 1;
    }
  });

  // ‚¨ÖÔ∏è Quay l·∫°i b√¨nh lu·∫≠n cha (n·∫øu c√≥)
  const backBtn = document.createElement('button');
  backBtn.className = 'btn btn-sm btn-secondary ms-3';
  backBtn.textContent = '‚¨Ö Quay l·∫°i';
  backBtn.style.display = 'none';
  modal.querySelector('.modal-header').appendChild(backBtn);

  backBtn.addEventListener('click', () => {
    if (threadHistory.length > 0) {
      const prev = threadHistory.pop();
      openThread(prev, false);
    }
    if (threadHistory.length === 0) backBtn.style.display = 'none';
  });

  const observer = new MutationObserver(() => {
    backBtn.style.display = threadHistory.length > 0 ? 'inline-block' : 'none';
  });
  observer.observe(replyList, { childList: true, subtree: true });
});

</script>
<script th:src="@{/js/theme-toggle.js}"></script>

</body>
</html>

