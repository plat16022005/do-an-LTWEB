<!DOCTYPE html>
<html lang="vi" data-bs-theme="dark" xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tìm kiếm - AloUTE</title>
<link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css"
	rel="stylesheet">
<link rel="stylesheet"
	href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
<link rel="stylesheet" th:href="@{/css/style.css}">
<style>
</style>
</head>
<body class="text-light">

	<nav class="navbar sticky-top">
		<div class="container-xl">
			<a class="navbar-brand fw-bold fs-4 d-flex align-items-center"
				th:href="@{/home}"> <svg class="bi me-2" width="32" height="32"
					fill="#0ea5e9">
					<path stroke-linecap="round" stroke-linejoin="round"
						stroke-width="2" d="M12 6.253v11.494m-9-5.747h18"
						stroke="currentColor"></path></svg> AloUTE
			</a>

		</div>
	</nav>

	<div class="container-xl mt-4">
		<div class="row g-4">
			<div class="col-lg-3 d-none d-lg-block">

				<aside class="sticky-top" style="top: 80px;">
					<ul class="nav flex-column gap-1">
						<li class="nav-item"><a
							class="nav-link rounded-pill fs-5 fw-bold d-flex align-items-center gap-3 p-2"
							href="/home"><i class="bi bi-house-door-fill fs-3"></i><span>Trang
									chủ</span></a></li>
						<li class="nav-item"><a
							class="nav-link rounded-pill fs-5 fw-bold d-flex align-items-center gap-3 p-2"
							href="/upload"><i class="bi bi-upload fs-3"></i><span>Đăng
									tải</span></a></li>
						<li class="nav-item"><a
							class="nav-link active rounded-pill fs-5 fw-bold d-flex align-items-center gap-3 p-2"
							href="/search"><i class="bi bi-search fs-3"></i><span>Tìm
									kiếm</span></a></li>
						<li class="nav-item"><a
							class="nav-link rounded-pill fs-5 fw-bold d-flex align-items-center gap-3 p-2"
							href="/friend"><i class="bi bi-people fs-3"></i><span>Bạn
									bè</span></a></li>
						<li class="nav-item"><a id="nav-group"
							class="nav-link rounded-pill fs-5 fw-bold d-flex align-items-center gap-3 p-2"
							href="/group"><i class="bi bi-globe2 fs-3"></i><span>Nhóm</span></a></li>
						<li class="nav-item"><a
							class="nav-link rounded-pill fs-5 fw-bold d-flex align-items-center gap-3 p-2"
							href="#"><i class="bi bi-envelope fs-3"></i><span>Tin
									nhắn</span></a></li>
						<li class="nav-item"><a
							class="nav-link rounded-pill fs-5 fw-bold d-flex align-items-center gap-3 p-2"
							href="#"><i class="bi bi-bell fs-3"></i><span>Thông
									báo</span></a></li>
						<li class="nav-item"><a
							class="nav-link rounded-pill fs-5 fw-bold d-flex align-items-center gap-3 p-2"
							th:href="@{/{username}(username=${user.nameUser})}"><i
								class="bi bi-person-circle fs-3"></i><span>Cá nhân</span></a></li>
						<li class="nav-item"><a
							class="nav-link rounded-pill fs-5 fw-bold d-flex align-items-center gap-3 p-2"
							href="/setting"><i class="bi bi-gear fs-3"></i><span>Cài
									đặt</span></a></li>
						<li class="nav-item mt-2"><a
							class="nav-link text-danger rounded-pill fs-5 fw-bold d-flex align-items-center gap-3 p-2"
							href="/logout"><i class="bi bi-box-arrow-right fs-3"></i><span>Đăng
									xuất</span></a></li>
					</ul>
				</aside>
			</div>

			<div class="col-lg-9">
				<main>
					<div class="card rounded-4">
						<div class="card-body p-4">
							<form method="get" action="/search">
								<div class="input-group mb-4">
									<span class="input-group-text"><i class="bi bi-search"></i></span>
									<input name="keyword" id="searchInput" type="text"
										class="form-control form-control-search form-control-lg"
										placeholder="Tìm kiếm bài viết hoặc người dùng..."
										th:value="${keyword}">
								</div>
							</form>

							<div id="resultsArea" th:if="${hasResults}"
								style="display: block;">
								<h4 id="resultsHeader" class="mb-3"
									th:text="'Kết quả cho &quot;' + ${keyword} + '&quot;'"></h4>

								<ul class="nav nav-pills mb-3">
									<li class="nav-item"><a class="nav-link active"
										data-bs-toggle="tab" href="#all-result">Tất cả</a></li>
									<li class="nav-item"><a class="nav-link"
										data-bs-toggle="tab" href="#result-post">Bài viết</a></li>
									<li class="nav-item"><a class="nav-link"
										data-bs-toggle="tab" href="#result-user">Người dùng</a></li>
									<li class="nav-item"><a class="nav-link enable"
										data-bs-toggle="tab" href="#result-group">Nhóm</a></li>
								</ul>
								<div class="tab-content">
									<!-- Tab Tất cả kết quả -->
									<div class="tab-pane fade show active" id="all-result">
										<div class="d-flex flex-column gap-3">
											<div th:each="rsUser : ${resultUsers}"
												class="d-flex justify-content-between align-items-center p-3 rounded-3 friend-item">
												<div class="d-flex align-items-center gap-3">
													<img th:src="${rsUser.avatarUrl}" class="rounded-circle"
														alt="Avatar" width="48" height="48">
													<div>
														<h6 th:text="${rsUser.fullName}" class="mb-0 fw-bold"></h6>
														<a class="fw mb-0 user-link" th:text="${rsUser.nameUser}"
															th:href="@{/{username}(username=${rsUser.nameUser})}"></a>
													</div>
												</div>
											</div>
											<div th:each="rsPost : ${resultPosts}"
												class="card rounded-4 overflow-hidden">
												<!-- Modal báo cáo bài viết -->
												<div class="modal fade"
													th:id="'reportPostModal__' + ${rsPost.postId}"
													tabindex="-1" aria-labelledby="reportPostLabel"
													aria-hidden="true">
													<div class="modal-dialog modal-dialog-centered">
														<div class="modal-content">
															<div class="modal-header">
																<h5 class="modal-title" id="reportPostLabel">Báo
																	cáo bài viết</h5>
																<button type="button" class="btn-close"
																	data-bs-dismiss="modal" aria-label="Đóng"></button>
															</div>
															<div class="modal-body">
																<form method="post" th:action="@{/report-post}">
																	<input type="hidden" name="postId"
																		th:value="${rsPost.postId}">
																	<div class="mb-3">
																		<label for="reason" class="form-label">Lý do
																			báo cáo</label>
																		<textarea name="reason" class="form-control" rows="4"
																			placeholder="Nhập lý do..."></textarea>
																	</div>
																	<div class="d-flex justify-content-end">
																		<button type="button" class="btn btn-secondary me-2"
																			data-bs-dismiss="modal">Hủy</button>
																		<button type="submit" class="btn btn-danger">Gửi
																			báo cáo</button>
																	</div>
																</form>
															</div>
														</div>
													</div>
												</div>
												<div class="card-body">
													<div
														class="d-flex align-items-center gap-3 mb-3 position-relative">
														<img class="rounded-circle"
															th:src="${rsPost.user.avatarUrl}" alt="Avatar" width="48"
															height="48">

														<div>
															<p class="fw-bold mb-0" th:text="${rsPost.user.fullName}">Tên
																người dùng</p>
															<a class="fw mb-0 user-link"
																th:text="${rsPost.user.nameUser}"
																th:href="@{/{username}(username=${rsPost.user.nameUser})}"></a>
															<p class="text-muted small mb-0">
																<span
																	th:text="${#temporals.format(rsPost.createdAt, 'dd/MM/yyyy HH:mm')}"></span>
															</p>
														</div>
														<!-- Góc phải: Visibility -->
														<div
															class="position-absolute top-0 end-0 me-2 mt-1 d-flex align-items-center gap-2">

															<!-- Nút tròn chỉnh sửa bài viết -->
															<button th:if="${rsPost.user.userId == user.userId}"
																type="button" class="btn btn-icon btn-gray-custom"
																th:attr="data-post-id=${rsPost.postId}"
																onclick="openEditPost(this)" title="Chỉnh sửa bài viết">
																<i class="bi bi-pencil-square"></i>
															</button>

															<!-- Nếu là bài viết của người khác -->
															<span class="badge rounded-pill bg-secondary text-light">
																<span th:switch="${rsPost.visibility}"> <span
																	th:case="'public'">Công khai</span> <span
																	th:case="'friends'">Bạn bè</span> <span
																	th:case="'private'">Chỉ mình tôi</span>
															</span>
															</span>
														</div>
													</div>
													<p th:text="${rsPost.content}"></p>
													<!-- Thư viện ảnh/video dạng thanh trượt -->
													<div
														th:if="${rsPost.attachments != null and !rsPost.attachments.isEmpty()}"
														class="attachment-scroll mt-3">

														<div th:each="att : ${rsPost.attachments}"
															class="attachment-item text-center">

															<!-- Nếu là ảnh -->
															<img th:if="${att.fileType.startsWith('image')}"
																th:src="${att.fileUrl}" alt="Ảnh đính kèm">

															<!-- Nếu là video -->
															<video th:if="${att.fileType.startsWith('video')}"
																th:src="${att.fileUrl}" controls class="rounded-3">
															</video>

															<!-- Nếu là file khác -->
															<a
																th:if="${!att.fileType.startsWith('image') and !att.fileType.startsWith('video')}"
																th:href="${att.fileUrl}" class="attachment-file"
																target="_blank"> <i class="bi bi-paperclip"></i> <span
																th:text="${#strings.substring(att.fileUrl, att.fileUrl.lastIndexOf('/') + 1)}"></span>
															</a>
														</div>
													</div>

												</div>

												<div class="card-body d-flex gap-2 post-actions">
													<div
														class="d-flex justify-content-between align-items-center w-100">
														<button
															class="btn text-muted d-flex align-items-center gap-2 like-btn"
															type="button" th:attr="data-post-id=${rsPost.postId}"
															th:attrappend="data-liked=${likedPostIds.contains(rsPost.postId)}">
															<i
																th:classappend="${likedPostIds.contains(rsPost.postId)} ? ' bi-heart-fill text-danger' : ' bi-heart'"
																class="bi"></i> <span th:text="${rsPost.likesCount}">0</span>
															<span class="ms-1">Thích</span>
														</button>
														<a th:href="@{/posts/{id}(id=${rsPost.postId})}" 
														   class="btn text-muted d-flex align-items-center gap-2">
														    <i class="bi bi-chat"></i>
														    <span th:text="${rsPost.commentsCount}">0</span>
														    <span class="ms-1">Bình luận</span>
														</a>
														<button
															th:if="${rsPost.user != null and user != null and rsPost.user.userId != user.userId}"
															class="btn text-muted d-flex align-items-center gap-2 repost-btn"
															th:attr="data-post-id=${rsPost.postId}"
															th:attrappend="data-reposted=${repostedPostIds.contains(rsPost.postId)}">
															<i
																th:classappend="${repostedPostIds.contains(rsPost.postId)} ? ' text-primary' : ''"
																class="bi bi-repeat"></i> <span
																th:text="${rsPost.shareCount}">0</span> <span
																class="ms-1">Đăng lại</span>
														</button>

														<button th:if="${rsPost.user.userId != user.userId}"
															class="btn text-muted d-flex align-items-center gap-2"
															data-bs-toggle="modal"
															th:attr="data-bs-target='#reportPostModal__' + ${rsPost.postId}">
															<i class="bi bi-flag"></i> <span class="ms-1">Báo
																cáo</span>
														</button>
													</div>
												</div>
											</div>
										</div>
									</div>

									<!-- Tab Lời mời đã nhận -->
									<div class="tab-pane fade" id="result-post">
										<div class="d-flex flex-column gap-3">
											<div th:each="rsPost : ${resultPosts}"
												class="card rounded-4 overflow-hidden">
												<!-- Modal báo cáo bài viết -->
												<div class="modal fade"
													th:id="'reportPostModal__' + ${rsPost.postId}"
													tabindex="-1" aria-labelledby="reportPostLabel"
													aria-hidden="true">
													<div class="modal-dialog modal-dialog-centered">
														<div class="modal-content">
															<div class="modal-header">
																<h5 class="modal-title" id="reportPostLabel">Báo
																	cáo bài viết</h5>
																<button type="button" class="btn-close"
																	data-bs-dismiss="modal" aria-label="Đóng"></button>
															</div>
															<div class="modal-body">
																<form method="post" th:action="@{/report-post}">
																	<input type="hidden" name="postId"
																		th:value="${rsPost.postId}">
																	<div class="mb-3">
																		<label for="reason" class="form-label">Lý do
																			báo cáo</label>
																		<textarea name="reason" class="form-control" rows="4"
																			placeholder="Nhập lý do..."></textarea>
																	</div>
																	<div class="d-flex justify-content-end">
																		<button type="button" class="btn btn-secondary me-2"
																			data-bs-dismiss="modal">Hủy</button>
																		<button type="submit" class="btn btn-danger">Gửi
																			báo cáo</button>
																	</div>
																</form>
															</div>
														</div>
													</div>
												</div>
												<div class="card-body">
													<div
														class="d-flex align-items-center gap-3 mb-3 position-relative">
														<img class="rounded-circle"
															th:src="${rsPost.user.avatarUrl}" alt="Avatar" width="48"
															height="48">

														<div>
															<p class="fw-bold mb-0" th:text="${rsPost.user.fullName}">Tên
																người dùng</p>
															<a class="fw mb-0 user-link"
																th:text="${rsPost.user.nameUser}"
																th:href="@{/{username}(username=${rsPost.user.nameUser})}"></a>
															<p class="text-muted small mb-0">
																<span
																	th:text="${#temporals.format(rsPost.createdAt, 'dd/MM/yyyy HH:mm')}"></span>
															</p>
														</div>
														<!-- Góc phải: Visibility -->
														<div
															class="position-absolute top-0 end-0 me-2 mt-1 d-flex align-items-center gap-2">

															<!-- Nút tròn chỉnh sửa bài viết -->
															<button th:if="${rsPost.user.userId == user.userId}"
																type="button" class="btn btn-icon btn-gray-custom"
																th:attr="data-post-id=${rsPost.postId}"
																onclick="openEditPost(this)" title="Chỉnh sửa bài viết">
																<i class="bi bi-pencil-square"></i>
															</button>

															<!-- Nếu là bài viết của người khác -->
															<span class="badge rounded-pill bg-secondary text-light">
																<span th:switch="${rsPost.visibility}"> <span
																	th:case="'public'">Công khai</span> <span
																	th:case="'friends'">Bạn bè</span> <span
																	th:case="'private'">Chỉ mình tôi</span>
															</span>
															</span>
														</div>
													</div>
													<p th:text="${rsPost.content}"></p>
													<!-- Thư viện ảnh/video dạng thanh trượt -->
													<div
														th:if="${rsPost.attachments != null and !rsPost.attachments.isEmpty()}"
														class="attachment-scroll mt-3">

														<div th:each="att : ${rsPost.attachments}"
															class="attachment-item text-center">

															<!-- Nếu là ảnh -->
															<img th:if="${att.fileType.startsWith('image')}"
																th:src="${att.fileUrl}" alt="Ảnh đính kèm">

															<!-- Nếu là video -->
															<video th:if="${att.fileType.startsWith('video')}"
																th:src="${att.fileUrl}" controls class="rounded-3">
															</video>

															<!-- Nếu là file khác -->
															<a
																th:if="${!att.fileType.startsWith('image') and !att.fileType.startsWith('video')}"
																th:href="${att.fileUrl}" class="attachment-file"
																target="_blank"> <i class="bi bi-paperclip"></i> <span
																th:text="${#strings.substring(att.fileUrl, att.fileUrl.lastIndexOf('/') + 1)}"></span>
															</a>
														</div>
													</div>

												</div>

												<div class="card-body d-flex gap-2 post-actions">
													<div
														class="d-flex justify-content-between align-items-center w-100">
														<button
															class="btn text-muted d-flex align-items-center gap-2 like-btn"
															type="button" th:attr="data-post-id=${rsPost.postId}"
															th:attrappend="data-liked=${likedPostIds.contains(rsPost.postId)}">
															<i
																th:classappend="${likedPostIds.contains(rsPost.postId)} ? ' bi-heart-fill text-danger' : ' bi-heart'"
																class="bi"></i> <span th:text="${rsPost.likesCount}">0</span>
															<span class="ms-1">Thích</span>
														</button>
														<a th:href="@{/posts/{id}(id=${rsPost.postId})}" 
														   class="btn text-muted d-flex align-items-center gap-2">
														    <i class="bi bi-chat"></i>
														    <span th:text="${rsPost.commentsCount}">0</span>
														    <span class="ms-1">Bình luận</span>
														</a>
														<button
															th:if="${rsPost.user != null and user != null and rsPost.user.userId != user.userId}"
															class="btn text-muted d-flex align-items-center gap-2 repost-btn"
															th:attr="data-post-id=${rsPost.postId}"
															th:attrappend="data-reposted=${repostedPostIds.contains(rsPost.postId)}">
															<i
																th:classappend="${repostedPostIds.contains(rsPost.postId)} ? ' text-primary' : ''"
																class="bi bi-repeat"></i> <span
																th:text="${rsPost.shareCount}">0</span> <span
																class="ms-1">Đăng lại</span>
														</button>

														<button th:if="${rsPost.user.userId != user.userId}"
															class="btn text-muted d-flex align-items-center gap-2"
															data-bs-toggle="modal"
															th:attr="data-bs-target='#reportPostModal__' + ${rsPost.postId}">
															<i class="bi bi-flag"></i> <span class="ms-1">Báo
																cáo</span>
														</button>
													</div>
												</div>
											</div>
										</div>
									</div>

									<!-- Tab Lời mời đã gửi -->
									<div class="tab-pane fade" id="result-user">
										<div class="d-flex flex-column gap-3">
											<div th:each="rsUser : ${resultUsers}"
												class="d-flex justify-content-between align-items-center p-3 rounded-3 friend-item">
												<div class="d-flex align-items-center gap-3">
													<img th:src="${rsUser.avatarUrl}" class="rounded-circle"
														alt="Avatar" width="48" height="48">
													<div>
														<h6 th:text="${rsUser.fullName}" class="mb-0 fw-bold"></h6>
														<a class="fw mb-0 user-link" th:text="${rsUser.nameUser}"
															th:href="@{/{username}(username=${rsUser.nameUser})}"></a>
													</div>
												</div>
											</div>
										</div>
									</div>
									<!-- Tab Lời mời đã gửi -->
									<div class="tab-pane fade" id="result-post">
										<div class="d-flex flex-column gap-3">
											<div th:each="friend : ${requestFriends}"
												class="d-flex justify-content-between align-items-center p-3 rounded-3 friend-item">
												<div class="d-flex align-items-center gap-3">
													<img th:src="${friend.avatarUrl}" class="rounded-circle"
														alt="Avatar" width="48" height="48">
													<div>
														<h6 th:text="${friend.fullName}" class="mb-0 fw-bold"></h6>
														<a class="fw mb-0 user-link" th:text="${friend.nameUser}"
															th:href="@{/{username}(username=${friend.nameUser})}"></a>
													</div>
												</div>
												<div class="d-flex gap-2">
													<form action="/friend/deny" method="post">
														<input type="hidden" name="friendId"
															th:value="${friend.userId}">
														<button type="submit"
															class="btn btn-sm btn-outline-warning rounded-pill">Hủy
															lời mời</button>
													</form>
												</div>
											</div>
										</div>
									</div>
								</div>
								<div id="resultsContainer" class="d-flex flex-column gap-3"></div>

								<p id="noResultsMessage" class="text-muted text-center mt-4"
									style="display: none;">Không tìm thấy kết quả nào.</p>
							</div>
						</div>
					</div>
				</main>
			</div>
		</div>
	</div>

	<script
		src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>

	<script th:src="@{/js/theme-toggle.js}"></script>

	<script>
document.addEventListener('DOMContentLoaded', () => {
	  const searchInput = document.getElementById('searchInput');
	  const keyword = searchInput.value.trim();

	  // Nếu URL có query keyword thì xóa đi (chỉ ảnh hưởng URL, không ảnh hưởng input)
	  if (keyword) {
	    const newUrl = window.location.origin + window.location.pathname;
	    window.history.replaceState({}, document.title, newUrl);
	  }
	});

const query = searchInput.value.trim();
if (query) {
  // Gửi form / fetch API
  const newUrl = window.location.origin + window.location.pathname;
  window.history.replaceState({}, document.title, newUrl);  // ✨ xóa keyword khỏi URL
}
</script>

	<script>
      document.addEventListener("DOMContentLoaded", function () {
        document.querySelectorAll(".like-btn").forEach(function (btn) {
          btn.addEventListener("click", function () {
            const postId = btn.getAttribute("data-post-id");
            const liked = btn.getAttribute("data-liked") === "true";
            fetch("/post/toggle-like/json", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                "X-Requested-With": "XMLHttpRequest",
              },
              body: JSON.stringify({ postId }),
            })
              .then((res) => res.json())
              .then((data) => {
                if (data.success) {
                  // Update like count
                  btn.querySelector("span").textContent = data.likesCount;
                  // Update icon
                  const icon = btn.querySelector("i");
                  if (data.liked) {
                    icon.classList.add("bi-heart-fill", "text-danger");
                    icon.classList.remove("bi-heart");
                    btn.setAttribute("data-liked", "true");
                  } else {
                    icon.classList.remove("bi-heart-fill", "text-danger");
                    icon.classList.add("bi-heart");
                    btn.setAttribute("data-liked", "false");
                  }
                } else {
                  alert("Có lỗi xảy ra khi cập nhật lượt thích.");
                }
              })
              .catch(() => {
                alert("Không thể kết nối đến máy chủ.");
              });
          });
        });
      });
    </script>
	<script>
document.addEventListener("DOMContentLoaded", function () {

  document.querySelectorAll(".repost-btn").forEach(function (btn) {
    btn.addEventListener("click", function () {
      const postId = btn.getAttribute("data-post-id");

      fetch("/post/toggle-repost/json", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-Requested-With": "XMLHttpRequest",
        },
        body: JSON.stringify({ postId }),
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          // ✅ Cập nhật số lượng đăng lại (span đầu tiên chứa số)
          const countSpan = btn.querySelector("span");
          countSpan.textContent = data.repostCount;

          // ✅ Đổi icon màu xanh khi đã đăng lại
          const icon = btn.querySelector("i");
          if (data.reposted) {
            icon.classList.add("text-primary");
          } else {
            icon.classList.remove("text-primary");
          }

          // ✅ Toast thông báo
          const toast = document.createElement('div');
          toast.className = 'alert alert-success position-fixed top-0 end-0 m-3 shadow';
          toast.style.zIndex = '1055';
          toast.textContent = data.reposted ? '✅ Đăng lại thành công!' : '⛔ Hủy đăng lại!';
          document.body.appendChild(toast);
          setTimeout(() => toast.remove(), 2000);

        } else {
          alert(data.message || "❌ Có lỗi xảy ra khi đăng lại.");
        }
      })
      .catch(() => {
        alert("⚠️ Không thể kết nối đến máy chủ.");
      });
    });
  });

});
</script>
	<script>
function openEditPost(button) {
    const postId = button.getAttribute('data-post-id');
    if (!postId) {
        console.error('❌ Không tìm thấy ID bài viết!');
        return;
    }
    window.location.href = `/posts/${postId}/edit`;
}

</script>
</body>
</html>