<!DOCTYPE html>
<html lang="vi" data-bs-theme="dark" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Kh√°m Ph√° - AloUTE</title>
    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Bootstrap Icons -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css"
    />
    <link rel="stylesheet" th:href="@{/css/style.css}" />
    <style></style>
  </head>
  <body class="text-light">
    <nav class="navbar sticky-top">
      <div class="container-xl">
        <a
          class="navbar-brand fw-bold fs-4 d-flex align-items-center"
          th:href="@{/home}"
        >
          <svg class="bi me-2" width="32" height="32" fill="#0ea5e9">
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M12 6.253v11.494m-9-5.747h18"
              stroke="currentColor"
            ></path>
          </svg>
          AloUTE
        </a>

        <ul
          class="navbar-nav flex-row gap-4 position-absolute start-50 translate-middle-x"
        >
          <li class="nav-item">
            <a
              class="nav-link active"
              aria-current="page"
              href="#"
              id="home-link"
              data-bs-toggle="tab"
              >C·ªông ƒë·ªìng</a
            >
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#" data-bs-toggle="tab" id="policy-link">B·∫°n b√®</a>
          </li>
        </ul>
      </div>
    </nav>

	<div class="container-xl mt-4">
		<div class="row g-4">
			<div class="col-lg-3 d-none d-lg-block">
				<aside class="sticky-top" style="top: 80px">
					<ul class="nav flex-column gap-1">
						<li class="nav-item"><a id="home-sidebar-button"
							class="nav-link active rounded-pill fs-5 fw-bold d-flex align-items-center gap-3 p-2"
							href="/home"> <i
								class="bi bi-house-door-fill fs-3"></i> <span>Trang ch·ªß</span>
						</a></li>
						<li class="nav-item"><a id="upload-sidebar-button"
							class="nav-link rounded-pill fs-5 fw-bold d-flex align-items-center gap-3 p-2"
							href="/upload"> <i
								class="bi bi-upload fs-3"></i> <span>ƒêƒÉng t·∫£i</span>
						</a></li>
						<li class="nav-item"><a id="nav-search"
							class="nav-link rounded-pill fs-5 fw-bold d-flex align-items-center gap-3 p-2"
							href="/search"> <i
								class="bi bi-search fs-3"></i> <span>T√¨m ki·∫øm</span>
						</a></li>
						<li class="nav-item"><a id="nav-friend"
							class="nav-link rounded-pill fs-5 fw-bold d-flex align-items-center gap-3 p-2"
							href="/friend"> <i
								class="bi bi-people fs-3"></i> <span>B·∫°n b√®</span>
						</a></li>
						<li class="nav-item"><a id="nav-group"
							class="nav-link rounded-pill fs-5 fw-bold d-flex align-items-center gap-3 p-2"
							href="/group"> <i class="bi bi-globe2 fs-3"></i>
								<span>Nh√≥m</span>
						</a></li>

						<li class="nav-item"><a id="nav-message"
							class="nav-link rounded-pill fs-5 fw-bold d-flex align-items-center gap-3 p-2"
							href="#"> <i class="bi bi-envelope fs-3"></i>
								<span>Tin nh·∫Øn</span>
						</a></li>
						<li class="nav-item"><a id="nav-notification"
							class="nav-link rounded-pill fs-5 fw-bold d-flex align-items-center gap-3 p-2"
							href="#"> <i class="bi bi-bell fs-3"></i> <span>Th√¥ng
									b√°o</span>
						</a></li>
						<li class="nav-item"><a
							class="nav-link rounded-pill fs-5 fw-bold d-flex align-items-center gap-3 p-2"
							th:href="@{/{username}(username=${user.nameUser})}">
								<i class="bi bi-person-circle fs-3"></i> <span>C√° nh√¢n</span>
						</a></li>
						<li class="nav-item"><a id="nav-setting"
							class="nav-link rounded-pill fs-5 fw-bold d-flex align-items-center gap-3 p-2"
							href="/setting"> <i class="bi bi-gear fs-3"></i>
								<span>C√†i ƒë·∫∑t</span>
						</a></li>
						<li class="nav-item mt-2"><a id="nav-logout"
							class="nav-link text-danger rounded-pill fs-5 fw-bold d-flex align-items-center gap-3 p-2"
							href="/logout"> <i
								class="bi bi-box-arrow-right fs-3"></i> <span>ƒêƒÉng xu·∫•t</span>
						</a></li>
					</ul>
				</aside>
			</div>

			<div class="col-lg-9">
				<div class="tab-pane fade show active" id="home-content">
					<main class="d-grid gap-3">
						<div th:each="post : ${posts}"
							class="card rounded-4 overflow-hidden">
							<!-- Modal b√°o c√°o b√†i vi·∫øt -->
							<div class="modal fade"
								th:id="'reportPostModal__' + ${post.postId}" tabindex="-1"
								aria-labelledby="reportPostLabel" aria-hidden="true">
								<div class="modal-dialog modal-dialog-centered">
									<div class="modal-content">
										<div class="modal-header">
											<h5 class="modal-title" id="reportPostLabel">B√°o c√°o b√†i
												vi·∫øt</h5>
											<button type="button" class="btn-close"
												data-bs-dismiss="modal" aria-label="ƒê√≥ng"></button>
										</div>
										<div class="modal-body">
											<form method="post" th:action="@{/report-post}">
												<input type="hidden" name="postId" th:value="${post.postId}" />
												<div class="mb-3">
													<label for="reason" class="form-label">L√Ω do b√°o
														c√°o</label>
													<textarea name="reason" class="form-control" rows="4"
														placeholder="Nh·∫≠p l√Ω do..."></textarea>
												</div>
												<div class="d-flex justify-content-end">
													<button type="button" class="btn btn-secondary me-2"
														data-bs-dismiss="modal">H·ªßy</button>
													<button type="submit" class="btn btn-danger">G·ª≠i
														b√°o c√°o</button>
												</div>
											</form>
										</div>
									</div>
								</div>
							</div>
							<div class="card-body">
								<div class="d-flex align-items-center gap-3 mb-3 position-relative">
									<img class="rounded-circle" th:src="${post.user.avatarUrl}"
										alt="Avatar" width="48" height="48" />

									<div>
										<p class="fw-bold mb-0" th:text="${post.user.fullName}">
											T√™n ng∆∞·ªùi d√πng</p>
										<a class="fw mb-0 user-link" th:text="${post.user.nameUser}"
											th:href="@{/{username}(username=${post.user.nameUser})}"></a>
										<p class="text-muted small mb-0">
											<span
												th:text="${#temporals.format(post.createdAt, 'dd/MM/yyyy HH:mm')}"></span>
										</p>
									</div>
									<!-- G√≥c ph·∫£i: Visibility -->
									<div class="position-absolute top-0 end-0 me-2 mt-1 d-flex align-items-center gap-2">
									
									    <!-- N√∫t tr√≤n ch·ªânh s·ª≠a b√†i vi·∫øt -->
									    <button th:if="${post.user.userId == user.userId}"
									            type="button"
									            class="btn btn-icon btn-gray-custom"
									            th:attr="data-post-id=${post.postId}"
									            onclick="openEditPost(this)"
									            title="Ch·ªânh s·ª≠a b√†i vi·∫øt">
									        <i class="bi bi-pencil-square"></i>
									    </button>
									
									    <!-- N·∫øu l√† b√†i vi·∫øt c·ªßa ng∆∞·ªùi kh√°c -->
									    <span class="badge rounded-pill bg-secondary text-light">
									        <span th:switch="${post.visibility}">
									            <span th:case="'public'">C√¥ng khai</span>
									            <span th:case="'friends'">B·∫°n b√®</span>
									            <span th:case="'private'">Ch·ªâ m√¨nh t√¥i</span>
									        </span>
									    </span>
									</div>										
								</div>
								<p th:text="${post.content}"></p>
								<!-- Th∆∞ vi·ªán ·∫£nh/video d·∫°ng thanh tr∆∞·ª£t -->
								<div
									th:if="${post.attachments != null and !post.attachments.isEmpty()}"
									class="attachment-scroll mt-3">
									<div th:each="att : ${post.attachments}"
										class="attachment-item text-center">
										<!-- N·∫øu l√† ·∫£nh -->
										<img th:if="${att.fileType.startsWith('image')}"
											th:src="${att.fileUrl}" alt="·∫¢nh ƒë√≠nh k√®m" />

										<!-- N·∫øu l√† video -->
										<video th:if="${att.fileType.startsWith('video')}"
											th:src="${att.fileUrl}" controls class="rounded-3"></video>

										<!-- N·∫øu l√† file kh√°c -->
										<a
											th:if="${!att.fileType.startsWith('image') and !att.fileType.startsWith('video')}"
											th:href="${att.fileUrl}" class="attachment-file"
											target="_blank"> <i class="bi bi-paperclip"></i> <span
											th:text="${#strings.substring(att.fileUrl, att.fileUrl.lastIndexOf('/') + 1)}"></span>
										</a>
									</div>
								</div>
							</div>

							<div class="card-body d-flex gap-2 post-actions">
								<div
									class="d-flex justify-content-between align-items-center w-100">
									<button
										class="btn text-muted d-flex align-items-center gap-2 like-btn"
										type="button" th:attr="data-post-id=${post.postId}"
										th:attrappend="data-liked=${likedPostIds.contains(post.postId)}">
										<i
											th:classappend="${likedPostIds.contains(post.postId)} ? ' bi-heart-fill text-danger' : ' bi-heart'"
											class="bi"></i> <span th:text="${post.likesCount}">0</span> <span
											class="ms-1">Th√≠ch</span>
									</button>
									
									<a th:href="@{/posts/{id}(id=${post.postId})}" 
									   class="btn text-muted d-flex align-items-center gap-2">
									    <i class="bi bi-chat"></i>
									    <span th:text="${post.commentsCount}">0</span>
									    <span class="ms-1">B√¨nh lu·∫≠n</span>
									</a>

									<button th:if="${post.user.userId != user.userId}"
									        class="btn text-muted d-flex align-items-center gap-2 repost-btn"
									        th:attr="data-post-id=${post.postId}"
									        th:attrappend="data-reposted=${repostedPostIds.contains(post.postId)}">
									    <i th:classappend="${repostedPostIds.contains(post.postId)} ? ' text-primary' : ''" class="bi bi-repeat"></i>
									    <span th:text="${post.shareCount}">0</span>
									    <span class="ms-1">ƒêƒÉng l·∫°i</span>
									</button>


									<button th:if="${post.user.userId != user.userId}"
										class="btn text-muted d-flex align-items-center gap-2"
										data-bs-toggle="modal"
										th:attr="data-bs-target='#reportPostModal__' + ${post.postId}">
										<i class="bi bi-flag"></i> <span class="ms-1">B√°o c√°o</span>
									</button>
								</div>
							</div>
						</div>
					</main>
				</div>

				<div class="d-none" id="friend-content">
					<main class="d-grid gap-3">
						<div th:each="post : ${friendPosts}"
							class="card rounded-4 overflow-hidden">
							<!-- Modal b√°o c√°o b√†i vi·∫øt -->
							<div class="modal fade"
								th:id="'reportPostModal__' + ${post.postId}" tabindex="-1"
								aria-labelledby="reportPostLabel" aria-hidden="true">
								<div class="modal-dialog modal-dialog-centered">
									<div class="modal-content">
										<div class="modal-header">
											<h5 class="modal-title" id="reportPostLabel">B√°o c√°o b√†i
												vi·∫øt</h5>
											<button type="button" class="btn-close"
												data-bs-dismiss="modal" aria-label="ƒê√≥ng"></button>
										</div>
										<div class="modal-body">
											<form method="post" th:action="@{/report-post}">
												<input type="hidden" name="postId" th:value="${post.postId}" />
												<div class="mb-3">
													<label for="reason" class="form-label">L√Ω do b√°o
														c√°o</label>
													<textarea name="reason" class="form-control" rows="4"
														placeholder="Nh·∫≠p l√Ω do..."></textarea>
												</div>
												<div class="d-flex justify-content-end">
													<button type="button" class="btn btn-secondary me-2"
														data-bs-dismiss="modal">H·ªßy</button>
													<button type="submit" class="btn btn-danger">G·ª≠i
														b√°o c√°o</button>
												</div>
											</form>
										</div>
									</div>
								</div>
							</div>
							<div class="card-body">
								<div class="d-flex align-items-center gap-3 mb-3 position-relative">
									<img class="rounded-circle" th:src="${post.user.avatarUrl}"
										alt="Avatar" width="48" height="48" />
									<div>
										<p class="fw-bold mb-0" th:text="${post.user.fullName}">
											T√™n ng∆∞·ªùi d√πng</p>
										<a class="fw mb-0 user-link" th:text="${post.user.nameUser}"
											th:href="@{/{username}(username=${post.user.nameUser})}"></a>
										<p class="text-muted small mb-0">
											<span
												th:text="${#temporals.format(post.createdAt, 'dd/MM/yyyy HH:mm')}"></span>
										</p>
									</div>
									<!-- G√≥c ph·∫£i: Visibility -->
									<div class="position-absolute top-0 end-0 me-2 mt-1 d-flex align-items-center gap-2">
									
									    <!-- N√∫t tr√≤n ch·ªânh s·ª≠a b√†i vi·∫øt -->
									    <button th:if="${post.user.userId == user.userId}"
									            type="button"
									            class="btn btn-icon btn-gray-custom"
									            th:attr="data-post-id=${post.postId}"
									            onclick="openEditPost(this)"
									            title="Ch·ªânh s·ª≠a b√†i vi·∫øt">
									        <i class="bi bi-pencil-square"></i>
									    </button>
									
									    <!-- N·∫øu l√† b√†i vi·∫øt c·ªßa ng∆∞·ªùi kh√°c -->
									    <span class="badge rounded-pill bg-secondary text-light">
									        <span th:switch="${post.visibility}">
									            <span th:case="'public'">C√¥ng khai</span>
									            <span th:case="'friends'">B·∫°n b√®</span>
									            <span th:case="'private'">Ch·ªâ m√¨nh t√¥i</span>
									        </span>
									    </span>
									</div>										
								</div>
								<p th:text="${post.content}"></p>
								<!-- Th∆∞ vi·ªán ·∫£nh/video d·∫°ng thanh tr∆∞·ª£t -->
								<div
									th:if="${post.attachments != null and !post.attachments.isEmpty()}"
									class="attachment-scroll mt-3">
									<div th:each="att : ${post.attachments}"
										class="attachment-item text-center">
										<!-- N·∫øu l√† ·∫£nh -->
										<img th:if="${att.fileType.startsWith('image')}"
											th:src="${att.fileUrl}" alt="·∫¢nh ƒë√≠nh k√®m" />

										<!-- N·∫øu l√† video -->
										<video th:if="${att.fileType.startsWith('video')}"
											th:src="${att.fileUrl}" controls class="rounded-3"></video>

										<!-- N·∫øu l√† file kh√°c -->
										<a
											th:if="${!att.fileType.startsWith('image') and !att.fileType.startsWith('video')}"
											th:href="${att.fileUrl}" class="attachment-file"
											target="_blank"> <i class="bi bi-paperclip"></i> <span
											th:text="${#strings.substring(att.fileUrl, att.fileUrl.lastIndexOf('/') + 1)}"></span>
										</a>
									</div>
								</div>
							</div>

							<div class="card-body d-flex gap-2 post-actions">
								<div
									class="d-flex justify-content-between align-items-center w-100">
									<button
										class="btn text-muted d-flex align-items-center gap-2 like-btn"
										type="button" th:attr="data-post-id=${post.postId}"
										th:attrappend="data-liked=${likedPostIds.contains(post.postId)}">
										<i
											th:classappend="${likedPostIds.contains(post.postId)} ? ' bi-heart-fill text-danger' : ' bi-heart'"
											class="bi"></i> <span th:text="${post.likesCount}">0</span> <span
											class="ms-1">Th√≠ch</span>
									</button>
									<a th:href="@{/posts/{id}(id=${post.postId})}" 
									   class="btn text-muted d-flex align-items-center gap-2">
									    <i class="bi bi-chat"></i>
									    <span th:text="${post.commentsCount}">0</span>
									    <span class="ms-1">B√¨nh lu·∫≠n</span>
									</a>
									<button th:if="${post.user.userId != user.userId}"
									        class="btn text-muted d-flex align-items-center gap-2 repost-btn"
									        th:attr="data-post-id=${post.postId}"
									        th:attrappend="data-reposted=${repostedPostIds.contains(post.postId)}">
									    <i th:classappend="${repostedPostIds.contains(post.postId)} ? ' text-primary' : ''" class="bi bi-repeat"></i>
									    <span th:text="${post.shareCount}">0</span>
									    <span class="ms-1">ƒêƒÉng l·∫°i</span>
									</button>
									<button th:if="${post.user.userId != user.userId}"
										class="btn text-muted d-flex align-items-center gap-2"
										data-bs-toggle="modal"
										th:attr="data-bs-target='#reportPostModal__' + ${post.postId}">
										<i class="bi bi-flag"></i> <span class="ms-1">B√°o c√°o</span>
									</button>
								</div>
							</div>
						</div>
					</main>
				</div>
			</div>
		</div>
	</div>

	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const homeLink = document.getElementById("home-link");
        const policyLink = document.getElementById("policy-link");
        const homeSidebarButton = document.getElementById(
          "home-sidebar-button"
        );

        const homeContent = document.getElementById("home-content");
        const policyContent = document.getElementById("friend-content");

        function showHome() {
          homeContent.classList.remove("d-none");
          policyContent.classList.add("d-none");

          homeLink.classList.add("active");
          policyLink.classList.remove("active");
        }

        function showPolicy() {
          homeContent.classList.add("d-none");
          policyContent.classList.remove("d-none");

          homeLink.classList.remove("active");
          policyLink.classList.add("active");
        }

        homeLink.addEventListener("click", (e) => {
          e.preventDefault();
          showHome();
        });

        homeSidebarButton.addEventListener("click", (e) => {
          e.preventDefault();
          showHome();
        });

        policyLink.addEventListener("click", (e) => {
        	  e.preventDefault();
        	  showPolicy();

        	  // üÜï Fetch d·ªØ li·ªáu friendPosts khi m·ªü tab b·∫°n b√®
        	  fetch("/api/friend-posts")
        	    .then(res => res.text())
        	    .then(html => {
        	      document.getElementById("friend-post-container").innerHTML = html;
        	    });
        	});
      });
    </script>

    <script>
      document.addEventListener("click", (e) => {
        const img = e.target.closest(".attachment-item img");
        if (!img) return;

        const overlay = document.createElement("div");
        overlay.style = `
    position: fixed; inset: 0;
    background: rgba(0,0,0,0.85);
    display: flex; align-items: center; justify-content: center;
    z-index: 9999;
  `;
        const fullImg = document.createElement("img");
        fullImg.src = img.src;
        fullImg.style = "max-width: 90%; max-height: 90%; border-radius: 8px;";

        overlay.appendChild(fullImg);
        document.body.appendChild(overlay);

        overlay.addEventListener("click", () => overlay.remove());
      });
    </script>
    <script>
      function scrollGallery(btn, direction) {
        const container = btn.parentElement.querySelector(".attachment-scroll");
        container.scrollBy({
          left: direction * 400,
          behavior: "smooth",
        });
      }
    </script>
    <script th:src="@{/js/theme-toggle.js}"></script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        document.querySelectorAll(".like-btn").forEach(function (btn) {
          btn.addEventListener("click", function () {
            const postId = btn.getAttribute("data-post-id");
            const liked = btn.getAttribute("data-liked") === "true";
            fetch("/post/toggle-like/json", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                "X-Requested-With": "XMLHttpRequest",
              },
              body: JSON.stringify({ postId }),
            })
              .then((res) => res.json())
              .then((data) => {
                if (data.success) {
                  // Update like count
                  btn.querySelector("span").textContent = data.likesCount;
                  // Update icon
                  const icon = btn.querySelector("i");
                  if (data.liked) {
                    icon.classList.add("bi-heart-fill", "text-danger");
                    icon.classList.remove("bi-heart");
                    btn.setAttribute("data-liked", "true");
                  } else {
                    icon.classList.remove("bi-heart-fill", "text-danger");
                    icon.classList.add("bi-heart");
                    btn.setAttribute("data-liked", "false");
                  }
                } else {
                  alert("C√≥ l·ªói x·∫£y ra khi c·∫≠p nh·∫≠t l∆∞·ª£t th√≠ch.");
                }
              })
              .catch(() => {
                alert("Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn m√°y ch·ªß.");
              });
          });
        });
      });
    </script>
<script>
document.addEventListener("DOMContentLoaded", function () {

  document.querySelectorAll(".repost-btn").forEach(function (btn) {
    btn.addEventListener("click", function () {
      const postId = btn.getAttribute("data-post-id");

      fetch("/post/toggle-repost/json", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-Requested-With": "XMLHttpRequest",
        },
        body: JSON.stringify({ postId }),
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          // ‚úÖ C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng ƒëƒÉng l·∫°i (span ƒë·∫ßu ti√™n ch·ª©a s·ªë)
          const countSpan = btn.querySelector("span");
          countSpan.textContent = data.repostCount;

          // ‚úÖ ƒê·ªïi icon m√†u xanh khi ƒë√£ ƒëƒÉng l·∫°i
          const icon = btn.querySelector("i");
          if (data.reposted) {
            icon.classList.add("text-primary");
          } else {
            icon.classList.remove("text-primary");
          }

          // ‚úÖ Toast th√¥ng b√°o
          const toast = document.createElement('div');
          toast.className = 'alert alert-success position-fixed top-0 end-0 m-3 shadow';
          toast.style.zIndex = '1055';
          toast.textContent = data.reposted ? '‚úÖ ƒêƒÉng l·∫°i th√†nh c√¥ng!' : '‚õî H·ªßy ƒëƒÉng l·∫°i!';
          document.body.appendChild(toast);
          setTimeout(() => toast.remove(), 2000);

        } else {
          alert(data.message || "‚ùå C√≥ l·ªói x·∫£y ra khi ƒëƒÉng l·∫°i.");
        }
      })
      .catch(() => {
        alert("‚ö†Ô∏è Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn m√°y ch·ªß.");
      });
    });
  });

});
</script>

<script>
function openEditPost(button) {
    const postId = button.getAttribute('data-post-id');
    if (!postId) {
        console.error('‚ùå Kh√¥ng t√¨m th·∫•y ID b√†i vi·∫øt!');
        return;
    }
    window.location.href = `/posts/${postId}/edit`;
}


</script>

</html>
